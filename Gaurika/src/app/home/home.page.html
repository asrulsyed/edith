<ion-header class="floating-header" [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="toggleSessionMenu()">
        <ion-label>{{ currentSessionName }}</ion-label>
        <ion-icon slot="end" name="chevron-down-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="openSettings()">
        <ion-icon name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-list lines="none">
    <ion-item *ngFor="let message of getFilteredMessages()"> 
      <ion-label
        [class.user-message]="message.role === 'user'"
        [class.assistant-message]="message.role === 'assistant'"
      >
        <span class="message-sender">
          {{ message.role === 'user' ? 'User' : model }}: 
        </span>
        <p class="message-content">{{ message.content }}</p>
        <img *ngIf="message.image" [src]="message.image" class="message-image" /> 
      </ion-label>
    </ion-item>
    <ion-item *ngIf="isStreaming">
      <ion-label class="writing-message">
        <span class="message-sender">{{ model }}: </span> 
        <ion-spinner *ngIf="!isToolCallInProgress()" name="crescent"></ion-spinner>
        <p class="message-content">
          {{ isToolCallInProgress() ? getToolCallInProgressMessage() : 'Writing...' }} 
        </p> 
      </ion-label>
    </ion-item>
  </ion-list>

  <div class="bottom-bar">
    <div class="bottom-toolbar">
      <ion-input
        [(ngModel)]="userInput"
        placeholder="Enter your message..."
      ></ion-input>
      <ion-button *ngIf="isMultimodalEnabled" class="upload-button" (click)="triggerImageUpload()">
        <ion-icon name="attach-outline"></ion-icon> 
      </ion-button>
      <input
        type="file"
        #fileInput
        (change)="onFileSelected($event)"
        style="display: none;"
        accept="image/*"
      >
      <ion-button
        class="send-button"
        (click)="sendMessage()"
        [disabled]="isStreaming || (userInput === '' && !selectedImage)" 
      >
        Send
      </ion-button>
    </div>
    <div *ngIf="selectedImage" class="image-preview">
      <img [src]="selectedImage" alt="Selected image" style="max-width: 200px; max-height: 150px;" /> 
      <ion-button (click)="removeSelectedImage()" fill="clear" color="danger">
        <ion-icon name="close-circle"></ion-icon>
      </ion-button>
    </div>
  </div>
</ion-content>

<ion-modal 
  [isOpen]="isSessionMenuOpen"
  class="session-menu"
  [presentingElement]="presentingElement"
  [canDismiss]="true"
  (ionModalDidDismiss)="isSessionMenuOpen = false"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Chat Sessions</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="toggleSessionMenu()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-list>
        <ion-item
          *ngFor="let session of sessions; let i = index"
          (click)="switchSession(i)"
        >
          {{ session.name }}
          <ion-button
            slot="end"
            fill="clear"
            color="danger"
            (click)="deleteSession(i)"
          >
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>
      <ion-button expand="block" (click)="createNewSession()">
        Create New Session
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  [isOpen]="isCreateSessionModalOpen"
  class="create-session-modal"
  [presentingElement]="presentingElement"
  [canDismiss]="true"
  (ionModalDidDismiss)="isCreateSessionModalOpen = false"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>New Chat Session</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="toggleCreateSessionModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-item>
        <ion-label position="floating">Session Name</ion-label>
        <ion-input [(ngModel)]="newSessionName"></ion-input>
      </ion-item>
      <ion-button expand="block" (click)="confirmNewSession()">Create</ion-button>
    </ion-content>
  </ng-template>
</ion-modal>