<!-- Main Content -->
<ion-header class="floating-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button class="sidebar-toggle" (click)="toggleSidebar()">
        <ion-icon slot="start" name="folder-open-outline" class="mr-2"></ion-icon>
        <ion-label *ngIf="!showTemplatesPage">{{ currentSessionName }}</ion-label>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="openSettings()">
        <ion-icon name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Right Sidebar -->
  <div class="right-sidebar" [class.open]="isRightSidebarOpen">
    <div class="sidebar-header">
      <h2>
        <ion-icon name="code-slash-outline" class="mr-2"></ion-icon>
        Code Snippets & Actions
      </h2>
      <ion-button class="close-button" (click)="toggleRightSidebar()">
        <ion-icon name="arrow-forward-outline"></ion-icon> 
      </ion-button>
    </div>
    <div class="code-snippet-container" *ngIf="selectedCodeSnippet">
      <pre><code>{{ selectedCodeSnippet }}</code></pre> 
      <ion-button class="copy-button" fill="clear" size="small" (click)="copyCode(selectedCodeSnippet)">
        <ion-icon name="copy-outline" class="mr-1"></ion-icon>
        <span class="copy-text">{{ isCopied ? 'Copied!' : 'Copy' }}</span>
      </ion-button>
    </div>
  </div>

  <!-- Left Sidebar -->
  <div class="sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <h2>
        <ion-icon name="chatbubbles-outline" class="mr-2"></ion-icon>
        Chats
      </h2>
      <ion-button class="close-button" (click)="toggleSidebar()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </div>
    <div class="session-list">
      <ion-item *ngFor="let session of sessions; let i = index" (click)="switchSession(i)">
        <ion-icon name="chatbox-outline" class="mr-2"></ion-icon>
        {{ session.name }}
        <ion-button slot="end" fill="clear" color="danger" (click)="deleteSession(i)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </ion-item>
    </div>
    <div class="sidebar-actions">
      <ion-button expand="block" (click)="showTemplatesAndRefresh()">
        <ion-icon name="create-outline" class="mr-2"></ion-icon>
        <span>New Chat</span>
      </ion-button>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true" [class.content-shift]="true" 
  [class.sidebar-open]="isSidebarOpen" 
  [class.right-sidebar-open]="isRightSidebarOpen">
  <div class="content-container">
    <!-- Templates Page -->
    <div *ngIf="showTemplatesPage" class="templates-page">
      <div class="templates-header">
        <h1 class="page-title">
          I'm Gaurika
        </h1>
        <p class="page-subtitle">
          Some responses may be inaccurate.
        </p>
      </div>
      <div class="templates-grid">
        <div *ngFor="let template of templateConversations" 
          class="template-item" 
          (click)="startConversation(template)">
          <div class="template-icon">
            <ion-icon [name]="getIconForTemplate(template.name)"></ion-icon>
          </div>
          <div class="template-content">
            <h2 class="template-title">{{ template.name }}</h2>
            <p class="template-description">{{ template.prompt }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Page -->
    <div *ngIf="!showTemplatesPage" class="chat-page">
      <ion-list lines="none">
        <ion-item *ngFor="let message of getFilteredMessages(); let i = index">
          <ion-label [class.user-message]="message.role === 'user'"
                    [class.assistant-message]="message.role === 'assistant'">
            <span class="message-sender">
              <ion-icon [name]="message.role === 'user' ? 'person-circle-outline' : 'desktop-outline'" class="mr-2"></ion-icon>
              {{ message.role === 'user' ? 'User' : 'Gaurika' }} :
            </span>

            <!-- Assistant Message Content -->
            <div *ngIf="message.role === 'assistant'" class="message-content">
              <ng-container *ngIf="!message.content.includes('```')">
                <div [innerHTML]="renderMarkdown(message.content)"></div>
              </ng-container>
              <ng-container *ngIf="message.content.includes('```')">
                <ng-container *ngFor="let part of splitMessageContent(message.content)">
                  <div *ngIf="part.type === 'text'" [innerHTML]="renderMarkdown(part.content)"></div>
                  <div *ngIf="part.type === 'code'" class="view-file-button" (click)="showCodeSnippet(part.content, part.language)">
                    <ion-icon name="code-slash-outline" class="mr-2"></ion-icon>
                    <span>View - {{ part.language || 'Code' }}</span>
                  </div>
                </ng-container>
              </ng-container>
              <div *ngIf="message.generatedImages?.length" class="generated-images">
                <img *ngFor="let image of message.generatedImages" 
                     [src]="image" 
                     class="generated-image" />
              </div>
            </div>

            <!-- User Message Content -->
            <div *ngIf="message.role === 'user'" class="message-content">
              <div [innerHTML]="renderMarkdown(getDisplayContent(message.content))"></div>
              <ion-button *ngIf="hasFileContext(message.content)"
                         fill="clear"
                         size="large"
                         (click)="showFileContext(message.content)"
                         class="file-preview">
                <ion-icon name="document-text-outline" class="mr-2"></ion-icon>
                <span class="file-preview-name">{{ extractFileNameFromContent(message.content) }}</span>
              </ion-button>
              <img *ngIf="message.image" [src]="message.image" class="message-image" />
            </div>

            <!-- Message Actions -->
            <ion-buttons slot="end">
              <ion-button *ngIf="message.role === 'user'"
                         (click)="deleteMessage(i)"
                         fill="clear"
                         color="danger">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
              <ion-button *ngIf="message.role === 'assistant'"
                         (click)="showAssistantMessageOptions(message, i)"
                         fill="clear">
                <ion-icon name="ellipsis-vertical"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-label>
        </ion-item>

        <!-- Writing Indicator -->
        <ion-item *ngIf="isStreaming">
          <ion-label class="writing-message">
            <span class="message-sender">
              <ion-icon name="desktop-outline" class="mr-2"></ion-icon>
              Gaurika :
            </span>
            <p class="message-content">Writing...</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>
  </div>
</ion-content>

<!-- Bottom Input Bar -->
<div class="bottom-bar" *ngIf="!isEditingMessage">
  <div class="bottom-toolbar">
    <ion-input #messageInput
               [(ngModel)]="userInput"
               placeholder="Send a message to start a conversation..."
               (keydown)="handleKeyDown($event)"
               [disabled]="isStreaming">
      <ion-icon name="chatbox-outline" slot="start" class="ml-2 mr-2"></ion-icon>
    </ion-input>
    <ion-button class="upload-button" 
                (click)="triggerFileUpload()" 
                [disabled]="isStreaming">
      <ion-icon name="attach-outline"></ion-icon>
    </ion-button>
    <input type="file" 
           #fileInput 
           (change)="onFileSelected($event)" 
           style="display: none" />
    <ion-button class="send-button" 
                (click)="isStreaming ? stopStream() : sendMessage()">
      <ion-icon [name]="isStreaming ? 'stop-outline' : 'paper-plane-outline'" class="mr-2"></ion-icon>
    </ion-button>
  </div>
  
  <!-- File Preview -->
  <ng-container *ngIf="selectedFile">
    <div *ngIf="selectedImage" class="image-preview">
      <img [src]="selectedImage" alt="Selected image" />
      <ion-button (click)="removeSelectedImage()" fill="clear" color="danger">
        <ion-icon name="close-circle"></ion-icon>
      </ion-button>
    </div>
    <div *ngIf="!selectedFile.type.startsWith('image/')" class="file-preview">
      <ion-icon [name]="getFileIcon(selectedFile.type)" class="file-preview-icon mr-2"></ion-icon>
      <span>{{ selectedFile.name }}</span>
      <ion-button (click)="removeSelectedImage()" fill="clear" color="danger">
        <ion-icon name="close-circle"></ion-icon>
      </ion-button>
    </div>
  </ng-container>
</div>

<!-- Edit Message Dialog -->
<div id="editMessageDialog" 
     class="custom-dialog" 
     *ngIf="isEditingMessage && selectedAssistantMessageIndex !== undefined">
  <div class="message-being-edited">
    <ion-label class="assistant-message">
      <div *ngFor="let line of messages[selectedAssistantMessageIndex].content.split('\n'); let j = index"
           [ngClass]="{ 'selected-line': isLineSelected(j) }">
        <ng-container *ngIf="line.trim().startsWith('```')">
          <pre><code>{{ line.substring(3).trim() }}</code></pre>
        </ng-container>
        <ng-container *ngIf="!line.trim().startsWith('```')">
          {{ line }}
        </ng-container>
      </div>
    </ion-label>
  </div>
  <ion-item>
    <ion-icon name="create-outline" slot="start" class="mr-2"></ion-icon>
    <ion-label position="floating">Edit Selected Lines</ion-label>
    <ion-input [(ngModel)]="editMessageInput" placeholder="Enter your changes"></ion-input>
  </ion-item>
  <div class="dialog-actions">
    <ion-button (click)="applyMagicSelectChanges(selectedAssistantMessageIndex, editMessageInput)">
      <ion-icon name="checkmark-outline" class="mr-2"></ion-icon>
      Apply Changes
    </ion-button>
    <ion-button color="danger" (click)="cancelEdit()">
      <ion-icon name="close-outline" class="mr-2"></ion-icon>
      Cancel
    </ion-button>
  </div>
</div>

<!-- Assistant Message Options -->
<ion-action-sheet
  [isOpen]="isAssistantMessageOptionsOpen"
  (didDismiss)="isAssistantMessageOptionsOpen = false"
  [buttons]="actionSheetButtons">
</ion-action-sheet>