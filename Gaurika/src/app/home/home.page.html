<!-- Main Content -->
<ion-header class="floating-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button class="sidebar-toggle" (click)="toggleSidebar()">
        <ion-icon slot="start" name="folder-open-outline" class="mr-2"></ion-icon>
        <!-- Only show session name if not on templates page and there's an active session -->
        <ion-label *ngIf="!showTemplatesPage && currentSessionIndex >= 0">{{ currentSessionName }}</ion-label>
        <!-- Show 'New Chat' if on templates page -->
        <ion-label *ngIf="showTemplatesPage"></ion-label>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="openSettings()">
        <ion-icon name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Right Sidebar -->
  <div class="right-sidebar" [class.open]="isRightSidebarOpen">
    <div class="sidebar-header">
      <h2>
        <ion-icon name="code-slash-outline" class="mr-2"></ion-icon>
        Code Snippets & Actions
      </h2>
      <ion-button class="close-button" (click)="toggleRightSidebar()">
        <ion-icon name="arrow-forward-outline"></ion-icon> 
      </ion-button>
    </div>
    <div class="code-snippet-container" *ngIf="selectedCodeSnippet">
      <pre><code>{{ selectedCodeSnippet }}</code></pre> 
      <ion-button class="copy-button" fill="clear" size="small" (click)="copyCode(selectedCodeSnippet)">
        <ion-icon name="copy-outline" class="mr-1"></ion-icon>
        <span class="copy-text">{{ isCopied ? 'Copied!' : 'Copy' }}</span>
      </ion-button>
    </div>
  </div>

  <!-- Left Sidebar -->
  <div class="sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <h2>
        <ion-icon name="chatbubbles-outline" class="mr-2"></ion-icon>
        Chats
      </h2>
      <ion-button class="close-button" (click)="toggleSidebar()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </div>
    <div class="session-list">
      <ion-item *ngFor="let session of sessions; let i = index" 
    (click)="editingSessionIndex === null && switchSession(i)"
    [class.active-session]="i === currentSessionIndex"
    [class.editing-session]="editingSessionIndex === i">
        <ion-icon name="chatbox-outline" class="mr-2"></ion-icon>
        
        <!-- Title display/edit mode -->
        <ng-container *ngIf="editingSessionIndex !== i">
          {{ session.name }}
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="startEditingSession(i, $event)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="deleteSession(i)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ng-container>

        <!-- Edit mode -->
        <ng-container *ngIf="editingSessionIndex === i">
          <ion-input 
            [(ngModel)]="editedSessionName"
            (keyup.enter)="saveSessionName(i, $event)"
            (keyup.escape)="cancelEditingSession()"
            #titleInput
            (click)="$event.stopPropagation()">
          </ion-input>
          <ion-buttons slot="end">
            <ion-button fill="clear" color="success" (click)="saveSessionName(i, $event)">
              <ion-icon name="checkmark-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="cancelEditingSession(); $event.stopPropagation()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ng-container>
      </ion-item>
    </div>
    <div class="sidebar-actions">
      <ion-button expand="block" (click)="showTemplatesAndRefresh()">
        <ion-icon name="create-outline" class="mr-2"></ion-icon>
        <span>New Chat</span>
      </ion-button>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true" [class.content-shift]="true" 
  [class.sidebar-open]="isSidebarOpen" 
  [class.right-sidebar-open]="isRightSidebarOpen">
  <div class="content-container">
    <div *ngIf="showTemplatesPage" class="landing-page">
      <div class="hero-section">
        <div class="hero-content">
          <div class="brand-logo">
            <img src="../../assets/icon/favicon.png" alt="Gaurika Logo">
          </div>
          <h1 class="hero-title">
            <span class="title">Gaurika</span>
            <span class="full-name">Gaurish's Advanced Universal Reasoning Interactive Knowledge Aid</span>
          </h1>
          <p class="hero-subtitle">AI Powered Knowledge Aid</p>
          
          <div class="search-container">
            <ion-searchbar 
              [(ngModel)]="templateSearchInput" 
              (ionInput)="filterTemplates()" 
              (ionClear)="filterTemplates()"
              (ionSearch)="submitSearch()"
              placeholder="Search templates or ask anything..." 
              showCancelButton="focus" 
              animated>
            </ion-searchbar>
            
            <!-- Suggestions Dropdown -->
            <div class="suggestions-window" *ngIf="templateSearchInput">
              <div *ngIf="templateSuggestions.length > 0">
                <div class="suggestion-item"
                     *ngFor="let template of templateSuggestions"
                     (click)="startConversation(template)">
                  <ion-icon [name]="getIconForTemplate(template.name)"></ion-icon>
                  <div class="suggestion-content">
                    <span class="template-name">{{ template.name }}</span>
                    <span class="template-description">{{ template.description }}</span>
                    <span class="template-prompt">{{ template.prompt }}</span>
                  </div>
                </div>
              </div>
              <div *ngIf="templateSuggestions.length === 0" class="no-templates-found">
                <div class="suggestion-item" (click)="submitSearch()">
                  <ion-icon name="chatbubbles-outline"></ion-icon>
                  <span>Start a new chat with "{{ templateSearchInput }}"</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <div class="templates-section">
        <div class="templates-grid">
          <!-- Quick Start Card -->
          <div class="template-card featured" (click)="startQuickChat()">
            <div class="card-content">
              <div class="card-header">
                <ion-icon name="rocket-outline"></ion-icon>
                <h3>Quick Start</h3>
              </div>
              <p class="card-description">Start a fresh conversation</p>
              <div class="card-prompt">
                <span class="prompt-label">Prompt : </span>
                <p class="prompt-text">[Ask anything you want!]</p>
              </div>
            </div>
          </div>
    
          <!-- Template Cards -->
          <div *ngFor="let template of filteredTemplates" 
               class="template-card" 
               (click)="startConversation(template)">
            <div class="card-content">
              <div class="card-header">
                <ion-icon [name]="getIconForTemplate(template.name)"></ion-icon>
                <h3>{{ template.name }}</h3>
              </div>
              <p class="card-description">{{ template.description }}</p>
              <div class="card-prompt">
                <span class="prompt-label">Prompt : </span>
                <p class="prompt-text">{{ template.prompt }}</p>
              </div>
            </div>
          </div>
    
          <!-- No Results Message -->
          <div *ngIf="filteredTemplates.length === 0 && templateSearchInput" 
               class="no-results">
            <ion-icon name="search-outline"></ion-icon>
            <p>No templates found matching "{{ templateSearchInput }}"</p>
            <p>Try searching for another keyword or ask a question directly!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Page -->
    <div *ngIf="!showTemplatesPage && currentSessionIndex >= 0" class="chat-page">
      <ion-list lines="none">
        <ion-item *ngFor="let message of getFilteredMessages(); let i = index">
          <ion-label [class.user-message]="message.role === 'user'"
                    [class.assistant-message]="message.role === 'assistant'">
                    <span class="message-sender">
                      <ion-icon [name]="message.role === 'user' ? 'person-circle-outline' : 'desktop-outline'" class="mr-2"></ion-icon>
                      {{ message.role === 'user' ? 'User' : 'Gaurika' }} :
                    </span>

            <!-- Assistant Message Content -->
            <div *ngIf="message.role === 'assistant'" class="message-content">
              <ng-container *ngIf="!message.content.includes('```')">
                <div [innerHTML]="renderMarkdown(message.content)"></div>
              </ng-container>
              <ng-container *ngIf="message.content.includes('```')">
                <ng-container *ngFor="let part of splitMessageContent(message.content)">
                  <div *ngIf="part.type === 'text'" [innerHTML]="renderMarkdown(part.content)"></div>
                  <div *ngIf="part.type === 'code'" class="view-file-button" (click)="showCodeSnippet(part.content, part.language)">
                    <ion-icon name="code-slash-outline" class="mr-2"></ion-icon>
                    <span>View - {{ part.language || 'Code' }}</span>
                  </div>
                </ng-container>
              </ng-container>
              <div *ngIf="message.generatedImages?.length" class="generated-images">
                <img *ngFor="let image of message.generatedImages" 
                     [src]="image" 
                     class="generated-image" />
              </div>
              <!-- Time Stamp -->
              <!-- <div class="message-timestamp">
                {{ message.timestamp | date: 'shortTime' }}
              </div> -->
            </div>

            <!-- User Message Content -->
            <div *ngIf="message.role === 'user'" class="message-content">
              <!-- Edit mode -->
              <div *ngIf="editingUserMessageIndex === i" class="edit-message-container">
                <ion-textarea
                  [(ngModel)]="editingUserMessageContent"
                  auto-grow="true"
                  class="edit-message-input">
                </ion-textarea>
                <div class="edit-actions">
                  <ion-button fill="clear" color="success" (click)="saveUserMessageEdit(i)">
                    <ion-icon name="checkmark-outline"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" color="danger" (click)="cancelUserMessageEdit()">
                    <ion-icon name="close-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
              
              <!-- Display mode -->
              <div *ngIf="editingUserMessageIndex !== i">
                <div [innerHTML]="renderMarkdown(getDisplayContent(message.content))"></div>
                <!-- Add this section to display user images -->
                <div *ngIf="message.image" class="user-image-container">
                  <img [src]="message.image" class="user-sent-image" alt="User sent image" />
                </div>
                <!-- Rest of existing user message content -->
              </div>
            
              <!-- Remove condition to show options for all messages -->
              <button class="toggle-actions" 
                      (click)="toggleMessageActions(i, message.role)"
                      *ngIf="message.role === 'user' || message.role === 'assistant'">
                <ion-icon name="ellipsis-vertical"></ion-icon>
              </button>
            </div>

            <!-- Inside ion-label, modify the message content and actions -->

            <div class="message-content">
              <!-- ... existing message content ... -->
            </div>

            <!-- For user messages -->
            <div *ngIf="message.role === 'user'" class="message-actions-wrapper">
              <button class="action-button" 
                      (click)="copyMessageToClipboard(message.content)" 
                      title="Copy">
                <ion-icon name="copy-outline"></ion-icon>
              </button>
              <button class="action-button" 
                      *ngIf="isLatestUserMessage(i)"
                      (click)="startEditUserMessage(i)" 
                      title="Edit">
                <ion-icon name="create-outline"></ion-icon>
              </button>
              <button class="action-button delete" 
                      (click)="deleteMessage(i)" 
                      title="Delete">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>

            <!-- For assistant messages -->
            <div *ngIf="message.role === 'assistant'" class="message-actions-wrapper">
              <button class="action-button" 
                      (click)="copyMessageToClipboard(message.content)" 
                      title="Copy">
                <ion-icon name="copy-outline"></ion-icon>
              </button>
              <button class="action-button" 
                      (click)="startEditMessage(i)" 
                      title="Refine">
                <ion-icon name="sparkles-outline"></ion-icon>  <!-- Changed from create-outline to star-outline -->
              </button>
              <button class="action-button" 
                      (click)="redoAssistantMessage(i)" 
                      title="Regenerate">
                <ion-icon name="refresh-outline"></ion-icon>
              </button>
              <button class="action-button delete" 
                      (click)="deleteMessage(i)" 
                      title="Delete">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
          </ion-label>
        </ion-item>

        <!-- Writing Indicator -->
        <div class="brand-logo-bottom" 
        [class.spinning]="isStreaming"  *ngIf="getFilteredMessages().length > 0">
     <img src="../../assets/icon/favicon.png" alt="Gaurika Logo">
   </div>
      </ion-list>
    </div>

    <!-- Show a message when no session is selected -->
    <div *ngIf="!showTemplatesPage && currentSessionIndex < 0" class="no-session-message">
      <h2>No chat selected</h2>
      <p>Please select a chat from the sidebar or start a new one</p>
    </div>
  </div>
</ion-content>

<!-- Bottom Input Bar -->
<div class="bottom-bar" *ngIf="!isEditingMessage">
  <div class="bottom-toolbar">
    <ion-input #messageInput
               [(ngModel)]="userInput"
               placeholder="Send a message..."
               (keydown)="handleKeyDown($event)"
               [disabled]="isStreaming">
      <ion-icon name="chatbox-outline" slot="start" class="ml-2 mr-2"></ion-icon>
    </ion-input>
    <ion-button class="upload-button" 
                (click)="triggerFileUpload()" 
                [disabled]="isStreaming">
      <ion-icon name="attach-outline"></ion-icon>
    </ion-button>
    <input type="file" 
           #fileInput 
           (change)="onFileSelected($event)" 
           style="display: none" />
    <ion-button class="send-button" 
                (click)="isStreaming ? stopStream() : sendMessage()">
      <ion-icon [name]="isStreaming ? 'stop-outline' : 'paper-plane-outline'" class="mr-2"></ion-icon>
    </ion-button>
  </div>
  
  <!-- File Preview -->
  <ng-container *ngIf="selectedFile">
    <div *ngIf="selectedImage" class="image-preview">
      <img [src]="selectedImage" alt="Selected image" />
      <ion-button (click)="removeSelectedImage()" fill="clear" color="danger">
        <ion-icon name="close-circle"></ion-icon>
      </ion-button>
    </div>
    <div *ngIf="!selectedFile.type.startsWith('image/')" class="file-preview">
      <ion-icon [name]="getFileIcon(selectedFile.type)" class="file-preview-icon mr-2"></ion-icon>
      <span>{{ selectedFile.name }}</span>
      <ion-button (click)="removeSelectedImage()" fill="clear" color="danger">
        <ion-icon name="close-circle"></ion-icon>
      </ion-button>
    </div>
  </ng-container>
</div>

<!-- Add backdrop div just before the dialog -->
<div class="dialog-backdrop" *ngIf="isEditingMessage"></div>

<!-- Replace existing edit message dialog -->
<div id="editMessageDialog" *ngIf="isEditingMessage && selectedAssistantMessageIndex !== undefined">
  <div class="dialog-header">
    <h2>
      <ion-icon name="create-outline"></ion-icon>
      Get a refined response
    </h2>
  </div>
  
  <div class="message-being-edited">
    {{ messages[selectedAssistantMessageIndex].content }}
  </div>
  
  <ion-item>
    <ion-label position="stacked">How should I modify this response?</ion-label>
    <ion-input 
      [(ngModel)]="editMessageInput" 
      placeholder="Describe your desired changes..."
      autofocus>
    </ion-input>
  </ion-item>

  <div class="dialog-actions">
    <ion-button (click)="applyMessageChanges(selectedAssistantMessageIndex, editMessageInput)">
      <ion-icon name="checkmark-outline" slot="start"></ion-icon>
      Apply Changes
    </ion-button>
    <ion-button color="medium" (click)="cancelEdit()">
      <ion-icon name="close-outline" slot="start"></ion-icon>
      Cancel
    </ion-button>
  </div>
</div>

<!-- Assistant Message Options -->
<ion-action-sheet
  [isOpen]="isAssistantMessageOptionsOpen"
  (didDismiss)="isAssistantMessageOptionsOpen = false"
  [buttons]="actionSheetButtons">
</ion-action-sheet>

<!-- User Message Options Action Sheet -->
<ion-action-sheet
  [isOpen]="isUserMessageOptionsOpen"
  (didDismiss)="isUserMessageOptionsOpen = false"
  [buttons]="userActionSheetButtons">
</ion-action-sheet>